openapi: 3.0.0
info:
  title: Coupe des Bains API
  version: 1.0.0
  description: API complète pour l'application Coupe des Bains des compétitions de la Société Fédérale de Gymnastique (FSG/STV).
servers:
  - url: /api
    description: Serveur API interne

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: Token d'authentification admin.

  schemas:
    # --- Modèles de base ---
    Apparatus:
      type: object
      properties:
        _id: { type: string }
        code: { type: string, description: "Code de l'engin (ex: SS, BA)" }
        name: { type: string, description: "Nom de l'engin (ex: Sol, Barres)" }
        icon: { type: string, description: "Identifiant de l'icône Iconify" }

    Group:
      type: object
      properties:
        _id: { type: string }
        name: { type: string }
        canton: { type: string }
        category: { type: string, enum: [ACTIFS, MIXTE] }
        logo: { type: string, nullable: true }
        description: { type: string, nullable: true }
        gymnastsCount: { type: number }

    Passage:
      type: object
      properties:
        _id: { type: string }
        group: { oneOf: [{ type: string }, { $ref: '#/components/schemas/Group' }] }
        apparatus: { oneOf: [{ type: string }, { $ref: '#/components/schemas/Apparatus' }] }
        startTime: { type: string, format: date-time }
        endTime: { type: string, format: date-time }
        location: { type: string }
        status: { type: string, enum: [SCHEDULED, LIVE, FINISHED] }
        score: { type: number, nullable: true }
        monitors: { type: array, items: { type: string } }

    Stream:
      type: object
      properties:
        _id: { type: string }
        name: { type: string }
        url: { type: string }
        location: { type: string }
        isLive: { type: boolean }
        currentPassage: { oneOf: [{ type: string }, { $ref: '#/components/schemas/Passage' }], nullable: true }

    # --- Objets de réponse enrichis ---
    PassageEnriched:
      allOf:
        - $ref: '#/components/schemas/Passage'
        - type: object
          properties:
            group: { $ref: '#/components/schemas/Group' }
            apparatus: { $ref: '#/components/schemas/Apparatus' }

    ResultsPassage:
      allOf:
        - $ref: '#/components/schemas/PassageEnriched'
        - type: object
          properties:
            rank: { type: number }

    ScheduleResponse:
      type: object
      properties:
        meta:
          type: object
          properties:
            availableApparatus:
              type: array
              items:
                type: object
                properties:
                  code: { type: string }
                  name: { type: string }
            availableDays: { type: array, items: { type: string } }
            availableCategories: { type: array, items: { type: string } }
            availableLocations: { type: array, items: { type: string } }
        data: { type: array, items: { $ref: '#/components/schemas/PassageEnriched' } }

    GroupDetailsResponse:
      type: object
      properties:
        info: { $ref: '#/components/schemas/Group' }
        stats:
          type: object
          properties:
            completedPassages: { type: number }
            totalPassages: { type: number }
            currentTotalScore: { type: number }
        monitors: { type: array, items: { type: string } }
        history:
          type: array
          items:
            type: object
            properties:
              year: { type: number }
              score: { type: number }
              apparatus: { type: string }
        timeline:
          type: array
          items:
            type: object
            properties:
              _id: { type: string }
              apparatus: { $ref: '#/components/schemas/Apparatus' }
              startTime: { type: string, format: date-time }
              endTime: { type: string, format: date-time }
              status: { type: string }
              score: { type: number, nullable: true }
              monitors: { type: array, items: { type: string } }
              location: { type: string }

paths:
  # --- Public ---
  /schedule:
    get:
      summary: Horaire complet avec filtres
      parameters:
        - name: day
          in: query
          schema: { type: string }
        - name: apparatus
          in: query
          schema: { oneOf: [{ type: string }, { type: array, items: { type: string } }] }
        - name: division
          in: query
          schema: { oneOf: [{ type: string }, { type: array, items: { type: string } }] }
        - name: salle
          in: query
          schema: { oneOf: [{ type: string }, { type: array, items: { type: string } }] }
      responses:
        '200':
          description: Liste des passages et métadonnées de filtrage
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ScheduleResponse' }

  /results:
    get:
      summary: Résultats par engin
      responses:
        '200':
          description: Objet groupé par code d'engin (ex { "SS": [...], "BA": [...] })
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: array
                  items: { $ref: '#/components/schemas/ResultsPassage' }

  /live:
    get:
      summary: Données temps réel (Passages LIVE et Streams actifs)
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  passages: { type: array, items: { $ref: '#/components/schemas/PassageEnriched' } }
                  streams: { type: array, items: { $ref: '#/components/schemas/Stream' } }

  /streams:
    get:
      summary: Liste des flux vidéo
      parameters:
        - name: isLive
          in: query
          schema: { type: boolean }
      responses:
        '200':
          content:
            application/json:
              schema: { type: array, items: { $ref: '#/components/schemas/Stream' } }

  /streams/{id}:
    get:
      summary: Détails d'un flux spécifique
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Stream' }

  /groups/{id}/details:
    get:
      summary: Détails complets d'un groupe (stats, histoire, timeline)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          content:
            application/json:
              schema: { $ref: '#/components/schemas/GroupDetailsResponse' }

  /weather:
    get:
      summary: Météo à Yverdon-les-Bains
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  temperature: { type: number }
                  raw: { type: object }

  # --- Notifications ---
  /notifications/subscribe:
    post:
      summary: S'abonner aux notifications WebPush
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                endpoint: { type: string }
                keys:
                  type: object
                  properties:
                    p256dh: { type: string }
                    auth: { type: string }
      responses:
        '200':
          content:
            application/json:
              schema: { type: object, properties: { success: { type: boolean } } }

  /notifications/sync:
    put:
      summary: Synchroniser les favoris pour les push notifications
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                endpoint: { type: string }
                favorites: { type: array, items: { type: string } }
      responses:
        '200':
          content:
            application/json:
              schema: { type: object, properties: { success: { type: boolean } } }

  # --- Admin ---
  /admin/login:
    post:
      summary: Connexion administration
      requestBody:
        content:
          application/json:
            schema: { type: object, properties: { password: { type: string } } }
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  token: { type: string }

  /admin/score:
    put:
      summary: Publier une note
      security: [{ BearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                passageId: { type: string }
                score: { type: number }
      responses:
        '200':
          content:
            application/json:
              schema: { type: object, properties: { ok: { type: boolean }, payload: { type: object } } }

  /admin/status:
    put:
      summary: Changer le statut d'un passage
      security: [{ BearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                passageId: { type: string }
                status: { type: string, enum: [SCHEDULED, LIVE, FINISHED] }
      responses:
        '200':
          content:
            application/json:
              schema: { type: object, properties: { ok: { type: boolean } } }

  /admin/stream:
    put:
      summary: Configurer un flux vidéo
      security: [{ BearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                streamId: { type: string }
                url: { type: string }
                isLive: { type: boolean }
                currentPassageId: { type: string, nullable: true }
      responses:
        '200':
          content:
            application/json:
              schema: { type: object, properties: { ok: { type: boolean } } }

  /admin/seed:
    post:
      summary: Réinitialiser la base de données (données de test)
      security: [{ BearerAuth: [] }]
      responses:
        '200':
          content:
            application/json:
              schema: { type: object, properties: { success: { type: boolean }, summary: { type: object } } }
